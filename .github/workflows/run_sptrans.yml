name: SPTrans Tracker

on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:

concurrency:
  group: sptrans-tracker
  cancel-in-progress: true

jobs:
  run-tracker:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Instalar depend√™ncias
        run: |
          pip install --upgrade pip
          pip install requests pandas tqdm lxml shapely pyproj

      - name: Criar estrutura completa de pastas
        run: |
          mkdir -p dados/raw/linhas
          mkdir -p dados/raw/paradas
          mkdir -p dados/raw/corredores
          mkdir -p dados/raw/empresas
          mkdir -p dados/raw/posicao_global
          mkdir -p dados/raw/posicao_linha
          mkdir -p dados/raw/posicao_garagem
          mkdir -p dados/raw/previsao
          mkdir -p dados/raw/kmz
          mkdir -p dados/curated
          mkdir -p dados/logs

      - name: Executar script principal
        env:
          SPTRANS_TOKEN: ${{ secrets.SPTRANS_TOKEN }}
          EXEC_MODE: github
        run: python coletor_sptrans.py


      - name: Commit autom√°tico dos dados
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add dados || true
          git commit -m "üì¶ Atualiza√ß√£o autom√°tica SPTrans $(date +'%Y-%m-%d %H:%M:%S')" || echo "Nada para commitar"

          git pull --rebase
          git push
